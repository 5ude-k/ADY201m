name: Crawl 2 Notebooks & Update SQL Daily

on:
  workflow_dispatch:          # Cho ph√©p ch·∫°y th·ªß c√¥ng
  schedule:
    - cron: "0 0 * * *"       # T·ª± ƒë·ªông 00:00 UTC (07:00 VN)

jobs:
  update-sql:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install pandas jupyter nbconvert beautifulsoup4 requests openpyxl

      # --- 1Ô∏è‚É£ Ch·∫°y notebook crawl_phongtro.ipynb ---
      - name: Run phongtro notebook
        run: |
          jupyter nbconvert --to python crawl_phongtro.ipynb --output crawl_phongtro.py
          python crawl_phongtro.py > crawl_output_1.txt

      # --- 2Ô∏è‚É£ Ch·∫°y notebook APICAO.ipynb ---
      - name: Run APICAO notebook
        run: |
          jupyter nbconvert --to python APICAO.ipynb --output APICAO.py
          python APICAO.py > crawl_output_2.txt

      # --- 3Ô∏è‚É£ G·ªôp CSV v√† c·∫≠p nh·∫≠t SQL ---
      - name: Merge CSV outputs and update SQL
        run: |
          python - <<'EOF'
          import pandas as pd
          import os
          from io import StringIO

          sql_file = "phongtro_danang.sql"

          def read_csv_output(path, fallback=None):
              """C·ªë ƒë·ªçc file CSV th·∫≠t n·∫øu c√≥, n·∫øu kh√¥ng th√¨ l·∫•y t·ª´ text output"""
              csv_file = fallback
              txt_file = path

              # ∆Øu ti√™n file CSV n·∫øu t·ªìn t·∫°i
              if csv_file and os.path.exists(csv_file):
                  print(f"üì¶ ƒê·ªçc file CSV {csv_file}")
                  return pd.read_csv(csv_file)
              
              # N·∫øu kh√¥ng, ƒë·ªçc t·ª´ output text
              with open(txt_file, "r", encoding="utf-8") as f:
                  lines = f.read().splitlines()
              for i, line in enumerate(lines):
                  if line.lower().startswith("location,"):
                      csv_str = "\n".join(lines[i:])
                      return pd.read_csv(StringIO(csv_str))
              return pd.DataFrame()

          # --- ƒê·ªçc d·ªØ li·ªáu t·ª´ 2 notebook ---
          df1 = read_csv_output("crawl_output_1.txt", "phongtro_danang.csv")
          df2 = read_csv_output("crawl_output_2.txt")

          df = pd.concat([df1, df2], ignore_index=True).drop_duplicates()

          if df.empty:
              print("‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ c·∫≠p nh·∫≠t.")
              exit(0)

          # L√†m s·∫°ch c∆° b·∫£n
          if "location" in df.columns:
              df["location"] = df["location"].astype(str).str.replace("'", "", regex=False)

          # ƒê·ªçc SQL c≈©
          existing_lines = set()
          if os.path.exists(sql_file):
              with open(sql_file, "r", encoding="utf-8") as f:
                  existing_lines = set(line.strip() for line in f if line.strip())

          # Sinh c√¢u INSERT
          new_lines = []
          for _, row in df.iterrows():
              def v(x):
                  if pd.isna(x) or x in ["", "None", "nan"]:
                      return "NULL"
                  return f"'{str(x).replace(\"'\", \"''\")}'"

              line = (
                  f"INSERT INTO phongtro_danang VALUES ("
                  f"{v(row.get('location'))}, {v(row.get('price'))}, {v(row.get('area'))}, "
                  f"{v(row.get('date_posted'))}, {v(row.get('fridge'))}, "
                  f"{v(row.get('washer'))}, {v(row.get('air_condition'))}, {v(row.get('wifi'))});"
              )

              if line not in existing_lines:
                  new_lines.append(line)

          # Ghi th√™m c√°c d√≤ng m·ªõi
          if new_lines:
              with open(sql_file, "a", encoding="utf-8") as f:
                  for line in new_lines:
                      f.write("\n" + line)
              print(f"‚úÖ ƒê√£ th√™m {len(new_lines)} d√≤ng m·ªõi v√†o {sql_file}")
          else:
              print("‚ö†Ô∏è Kh√¥ng c√≥ d√≤ng m·ªõi ƒë·ªÉ th√™m (t·∫•t c·∫£ ƒë√£ t·ªìn t·∫°i).")
          EOF

      # --- 4Ô∏è‚É£ Commit & Push ---
      - name: Commit & Push Changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add phongtro_danang.sql phongtro_danang.csv || true
          git commit -m "Daily update from both notebooks (merged unique rows)" || echo "No changes"
          git push || echo "No changes to push"
