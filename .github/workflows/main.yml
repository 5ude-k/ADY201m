name: Crawl & Update SQL Daily

on:
  workflow_dispatch:          # Cho phép chạy thủ công
  schedule:
    - cron: "0 0 * * *"       # Chạy tự động mỗi ngày 00:00 UTC (07:00 VN)

jobs:
  update-sql:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install pandas jupyter nbconvert

      - name: Convert Notebook to Python
        run: |
          jupyter nbconvert --to python APICAO.ipynb --output APICAO.py

      - name: Run crawler and capture CSV output
        run: |
          python APICAO.py > crawl_output.txt

      - name: Update SQL File
        run: |
          python - << 'EOF'
          import pandas as pd
          from io import StringIO

          sql_file = "phongtro_danang.sql"

          # ==== ĐỌC OUTPUT TỪ NOTEBOOK ====
          with open("crawl_output.txt", "r", encoding="utf-8") as f:
              lines = f.read().splitlines()

          # Tìm dòng chứa header CSV (dòng bắt đầu bằng "location")
          csv_start = None
          for i, line in enumerate(lines):
              if line.lower().startswith("location,"):
                  csv_start = i
                  break

          if csv_start is None:
              raise Exception("❌ Không tìm thấy CSV trong output APICAO.py")

          csv_data = "\n".join(lines[csv_start:]).strip()

          df = pd.read_csv(StringIO(csv_data))

          # ==== ĐỌC SQL CŨ ====
          with open(sql_file, "r", encoding="utf-8") as f:
              existing_lines = set(line.strip() for line in f if line.strip())

          # ==== THÊM DÒNG MỚI NẾU CHƯA TỒN TẠI ====
          new_lines = []
          for _, row in df.iterrows():
              def v(x):
                  return "NULL" if x is None else f"'{x}'"
              
              line = f"INSERT INTO phongtro_danang VALUES ({v(row['location'])}, {v(row['price'])}, {v(row['area'])}, {v(row['date_posted'])}, {v(row['fridge'])}, {v(row['washer'])}, {v(row['air_condition'])}, {v(row['wifi'])});"
              
              if line not in existing_lines:
                  new_lines.append(line)

          if new_lines:
              with open(sql_file, "a", encoding="utf-8") as f:
                  for line in new_lines:
                      f.write("\n" + line)

              print(f'✅ Đã thêm {len(new_lines)} dòng mới vào SQL')
          else:
              print("⚠️ Không có dữ liệu mới')
          EOF

      - name: Commit & Push Changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add phongtro_danang.sql
          git commit -m "Daily auto-update SQL data" || echo "No changes to commit"
          git push || echo "No changes to push"

